<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Poznámky</title>
  <link rel="stylesheet" href="/style-registrace.css">
</head>
<body>
  <h1>Moje Poznámky</h1>

  <!-- Formulář pro přidání nové poznámky -->
  <form id="noteForm">
    <input type="text" id="title" name="title" placeholder="Nadpis poznámky" required />
    <textarea id="content" name="content" placeholder="Obsah poznámky" required></textarea><br />
    <button type="submit">Přidat poznámku</button>
  </form>

  <!-- Místo pro výpis poznámek -->
  <div id="notesList">
    <!-- Poznámky budou tady dynamicky -->
  </div>

  <button id="logoutButton" style="display:none;">Odhlásit se</button>

  <button id="deleteAccountBtn">Zrušit účet</button>
  <div id="deleteAccountForm" style="display:none; margin-top:10px;">
    <input type="password" id="deletePassword" placeholder="Zadej heslo pro zrušení účtu" />
    <button id="confirmDeleteBtn">Potvrdit zrušení účtu</button>
  </div>

  <label class="switch">
    <input type="checkbox" id="importantOnly">
    <span class="slider"></span>
    Zobrazit pouze důležité poznámky
  </label>
  <script>
    // Zkontroluj, jestli je uživatel přihlášený, například pomocí session
    fetch('/checkSession', { method: 'GET' })
      .then(response => response.json())
      .then(data => {
        console.log('Status session při načítání poznamky:', data); // Výpis stavu session
        if (data.loggedIn) {
          // Uživatel je přihlášen, tlačítko pro odhlášení je aktivní
          document.getElementById('logoutButton').style.display = 'block';
        } else {
          console.log('Uživatel není přihlášen. Přesměrování na přihlašovací stránku.');
          window.location.href = '/index.html';
        }
      });

    // Načítání poznámek po načtení stránky
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/notes', { method: 'GET' })
        .then(response => response.json())
        .then(data => {
          const notesList = document.getElementById('notesList');
          notesList.innerHTML = ''; // Nejprve vymaž staré poznámky

          data.forEach((note, index) => {
            const noteDiv = document.createElement('div');
            noteDiv.classList.add('note');
            noteDiv.innerHTML = `
              <h3>${note.title}</h3>
              <p>${note.content}</p>
              <button class="importantButton" data-index="${index}">${note.important ? 'Odebrat důležitost' : 'Označit jako důležitou'}</button>
              <button class="deleteButton" data-index="${index}">Smazat</button>
            `;
            notesList.appendChild(noteDiv);
          });
        });
    });

    // Přidání poznámky
    document.getElementById('noteForm').addEventListener('submit', function(event) {
      event.preventDefault();

      const titleInput = document.getElementById('title');
      const contentInput = document.getElementById('content');

      const title = titleInput.value;
      const content = contentInput.value;

      fetch('/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, content })
      })
      .then(response => response.json())
      .then(data => {
        const noteDiv = document.createElement('div');
        noteDiv.classList.add('note');
        noteDiv.innerHTML = `
          <h3>${data.title}</h3>
          <p>${data.content}</p>
          <button class="importantButton" data-index="0">Označit jako důležitou</button>
          <button class="deleteButton" data-index="0">Smazat</button>
        `;
        document.getElementById('notesList').appendChild(noteDiv);

        // Vymazání vstupních polí
        titleInput.value = '';
        contentInput.value = '';
      });
    });

    // Odhlášení uživatele
    document.getElementById('logoutButton').addEventListener('click', async () => {
      await fetch('/logout', { method: 'POST' });
      window.location.href = '/index.html'; // Přesměrování na přihlašovací stránku
    });

    // Změna důležitosti poznámky
    document.getElementById('notesList').addEventListener('click', function(event) {
      if (event.target && event.target.classList.contains('importantButton')) {
        const index = event.target.getAttribute('data-index');
        fetch(`/notes/${index}/important`, {
          method: 'PUT'
        })
        .then(response => response.json())
        .then(data => {
          event.target.textContent = data.note.important ? 'Odebrat důležitost' : 'Označit jako důležitou';
        });
      }
    });

    // Zobrazit formulář pro zrušení účtu
    document.getElementById('deleteAccountBtn').addEventListener('click', () => {
      document.getElementById('deleteAccountForm').style.display = 'block';
    });

    // Odeslání požadavku na zrušení účtu
    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      const password = document.getElementById('deletePassword').value;

      const response = await fetch('/deleteAccount', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });

      const result = await response.json();

      if (response.ok) {
        alert(result.message);
        window.location.href = '/index.html';
      } else {
        alert(result.message || 'Chyba při rušení účtu.');
      }
    });

    // Smazání poznámky
    document.getElementById('notesList').addEventListener('click', function(event) {
      if (event.target && event.target.classList.contains('deleteButton')) {
        const index = event.target.getAttribute('data-index');
        fetch(`/notes/${index}`, {
          method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
          // Po smazání poznámky ji odstraníme ze seznamu na stránce
          event.target.parentElement.remove();
        });
      }
    });

    document.getElementById('importantOnly').addEventListener('change', function () {
    fetch('/notes')
      .then(res => res.json())
      .then(notes => {
        const list = document.getElementById('notesList');
        list.innerHTML = '';

        const showOnlyImportant = this.checked;
        const filtered = showOnlyImportant ? notes.filter(n => n.important) : notes;

        filtered.forEach(note => {
          const div = document.createElement('div');
          div.innerHTML = `
            <h3>${note.title}</h3>
            <p>${note.content}</p>
            ${note.important ? '<strong style="color:red;">Důležité</strong>' : ''}
          `;
          list.appendChild(div);
        });
      });
  });

  window.addEventListener('DOMContentLoaded', () => {
  fetch('/notes')
    .then(res => res.json())
    .then(notes => {
      const list = document.getElementById('notesList');
      list.innerHTML = ''; // vyčisti

      notes.forEach(note => {
        const div = document.createElement('div');
        div.innerHTML = `
          <h3>${note.title}</h3>
          <p>${note.content}</p>
          ${note.important ? '<strong style="color:red;">Důležité</strong>' : ''}
        `;
        list.appendChild(div);
      });
    });
});
  </script>
</body>
</html>